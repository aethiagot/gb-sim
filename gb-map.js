var WHITE = 0;      //Glory Faction
var PINK = 1;       // Shadow Faction
var ORANGE = 2;     // Lordsbane Faction
var GREEN = 3;      // Ages Faction
var PURPLE = 4;     // Tempest Faction
var RED = 5;        // Scarlet Faction
var YELLOW = 6;     // Longreach Faction
var AQUA = 7;       // Frost Faction
var BLUE = 8;       // Justice Faction

var links = [[41,42,43,44,45,46,47,48],[113,169],[114,170],[115,171],[116,172],[117,173],[118,174],[119,175],[120,176],[113,169],[114,170],[115,171],[116,172],[117,173],[118,174],[119,175],[120,176],[64,80,168,193],[57,73,161,193],[58,74,162,194],[59,75,163,194],[60,76,164,195],[61,77,165,195],[62,78,166,196],[63,79,167,196],[64,145,56],[57,146,49],[57,147,49],[58,148,50],[58,149,50],[59,150,51],[59,151,51],[60,152,52],[60,153,52],[61,154,53],[61,155,53],[62,156,54],[62,157,54],[63,158,55],[63,159,55],[64,160,56],[72,0],[65,0],[66,0],[67,0],[68,0],[69,0],[70,0],[71,0],[26,27,81,89,97,105],[28,29,82,90,98,106],[30,31,83,91,99,107],[32,33,84,92,100,108],[34,35,85,93,101,109],[36,37,86,94,102,110],[38,39,87,95,103,111],[25,40,88,96,104,112],[18,26,27,193],[19,28,29,194],[20,30,31,194],[21,32,33,195],[22,34,35,195],[23,36,37,196],[24,38,39,196],[17,25,40,193],[122,123,137,138,161,42],[124,125,138,139,162,43],[126,127,139,140,163,44],[128,129,140,141,164,45],[130,131,141,142,165,46],[132,133,142,143,166,47],[134,135,143,144,167,48],[121,136,137,144,168,41],[18],[19],[20],[21],[22],[23],[24],[17],[49],[50],[51],[52],[53],[54],[55],[56],[49],[50],[51],[52],[53],[54],[55],[56],[49],[50],[51],[52],[53],[54],[55],[56],[49],[50],[51],[52],[53],[54],[55],[56],[1,9,177],[2,10,179],[3,11,181],[4,12,183],[5,13,185],[6,14,188],[7,15,189],[8,16,191],[72,197],[65,197],[65,198],[66,198],[66,199],[67,199],[67,200],[68,200],[68,201],[69,201],[69,202],[70,202],[70,203],[71,203],[71,204],[72,204],[65,72],[65,66],[66,67],[67,68],[68,69],[69,70],[70,71],[71,72],[25,177],[26,178],[27,179],[28,180],[29,181],[30,182],[31,183],[32,184],[33,185],[34,186],[35,187],[36,188],[37,189],[38,190],[39,191],[40,192],[18,65],[19,66],[20,67],[21,68],[22,69],[23,70],[24,71],[17,72],[1,9,178],[2,10,180],[3,11,182],[4,12,184],[5,13,186],[6,14,187],[7,15,190],[8,16,192],[113,145],[146,169],[114,147],[148,170],[115,149],[171,150],[116,151],[152,172],[117,153],[154,173],[155,174],[118,156],[119,157],[158,175],[120,159],[160,176],[17,18,57,64,197],[19,20,58,59,199],[21,22,60,61,201],[23,24,62,63,203],[121,122,193],[123,124],[125,126,194],[127,128],[129,130,195],[131,132],[133,134,196],[135,136]];
var last = [0,1,2,3,4,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
var map = [0,1,2,3,4,5,6,7,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
var inf = [3000,0,0,0,0,0,0,0,0,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,700,700,700,700,700,700,700,700,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,200,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,700,700,700,700,700,700,700,700,200,200,200,200,200,200,200,200,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,700,700,700,700,700,700,700,700,700,700,700,700];
var score = [74200,0,0,0,0,0,0,0,0];

function initialize() {
    var idx = document.URL.indexOf('?');
    if (idx != -1) { //TODO: Check valid input values
        var val = document.URL.substring(idx+4, document.URL.length);
        for(var i = 0; i < val.length; i++) {
            var j = parseInt(val[i]);
            score[map[i]] -= inf[i];
            map[i] = j;
            score[map[i]] += inf[i];
            refreshBuilding(i);
        }
    }
    drawLinks();
}

function drawLinks() {
    for (var i = 0; i < links.length; i++) {
        var l = links[i];
        for (var j = 0; j < l.length; j++)
            if (l[j] != 0)
                drawLink(i,l[j]);
    }
}

function getColor(i1,i2) {
    if (map[i1] == map[i2]) {
        switch(map[i1]) {
            case PINK:   
                return "#DE517B";
            case ORANGE:
                return "#E9823F";
            case GREEN: 
                return "#84EB86";
            case PURPLE: 
                return "#CE7ED6";
            case RED: 
                return "#E4222E";
            case YELLOW: 
                return "#F1BF4A";
            case AQUA: 
                return "#7BEBD6";
            case BLUE: 
                return "#9FD5FC";
            default:
                return "#F1F1F1";
        }
    }
    return "#F1F1F1";
}

String.prototype.replaceAt = function(index, replacement) {
    return this.substr(0, index) + replacement + this.substr(index + replacement.length);
}

function drawLink(i1, i2) {
    var ele1 = $("#item"+i1);
    var ele2 = $("#item"+i2);
    var pos1 = ele1.position();
    var pos2 = ele2.position();
    var w1 = ele1.width();
    var w2 = ele2.width();
    var h1 = ele1.height();
    var h2 = ele2.height();
    
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    ctx.beginPath();
    ctx.strokeStyle = "#202020";
    ctx.lineWidth = 5;
    ctx.moveTo(pos1.left + w1/2,pos1.top + h1/2);
    ctx.lineTo(pos2.left + w2/2, pos2.top + h2/2);
    ctx.stroke();
    ctx.strokeStyle = getColor(i1,i2);
    ctx.lineWidth = 3;
    ctx.moveTo(pos1.left + w1/2,pos1.top + h1/2);
    ctx.lineTo(pos2.left + w2/2, pos2.top + h2/2);
    ctx.stroke();
}

function getNextColor(id) {
    var res = []
    for(var i = 0; i < links[id].length; i++){
        var color = map[links[id][i]];
        if (color != map[id] && color > last[id] && res.indexOf(color) == -1){
            res.push(color);
        }
    }
    res.sort();
    if (res.length == 0) {
        last[id] = 0;
        return 0;
    }
    else {
        last[id] = res[0];
        return res[0];
    }
}

function refreshBuilding(id) {
    var ele = $("#item" + id);
    var src = ele.attr('src').split('');
    src[10] = map[id]; //TODO: dymamic
    src = src.join('');
    ele.attr('src',src);
}

function reset() {
    for(var i = 9; i < map.length; i++) {
        map[i] = 0;
        last[i] = 0;
        refreshBuilding(i);
    }
    map[0] = 0;
    last[0] = 0;
    refreshBuilding(0);
    updateURL();
    drawLinks();
}

function attack(id) {
    score[map[id]] -= inf[id];
    map[id] = getNextColor(id);
    score[map[id]] += inf[id];
    refreshBuilding(id)
    drawLinks();
    updateURL();
}

function updateURL() {
    var url_export = "";
    for(var i = 0; i < map.length; i++)
        url_export += map[i];
    
    var url = new URL(document.URL.toString());
    var query_string = url.search;
    var search_params = new URLSearchParams(query_string); 
    search_params.set('id', url_export);
    url.search = search_params.toString();
    var new_url = url.toString();
    if (history.pushState)
        window.history.pushState("", "", new_url);
    else
        document.location.href = new_url;
}
